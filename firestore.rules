rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Règles pour les utilisateurs
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'parent';
      allow delete: if request.auth.uid == userId;
    }

    // Règles pour les unités
    // - Lecture publique pour permettre la recherche par code d'accès lors de l'inscription
    // - Création: uniquement admin WeCamp
    // - Modification: admin WeCamp OU tout animateur de l'unité (pour logo, description, etc.)
    // - Suppression: uniquement admin WeCamp
    match /units/{unitId} {
      allow read: if true;

      // Création d'unité: uniquement admin WeCamp
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin';

      // Modification: admin WeCamp OU tout animateur de cette unité
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin' ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.unitId == unitId)
      );

      // Suppression: uniquement admin WeCamp
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin';
    }

    // Règles pour les groupes scouts
    match /scoutGroups/{groupId} {
      allow read: if true; // Lecture publique
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour les défis
    // - Admin WeCamp: peut tout faire
    // - Animateur: peut créer et modifier uniquement les défis qu'il a créés lui-même (pas les défis créés par WeCamp admin)
    match /challenges/{challengeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['animator', 'wecamp_admin'];

      // Update: wecamp_admin peut tout modifier
      // Animateur peut modifier uniquement les défis qu'il a créés lui-même
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin' ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' &&
         resource.data.unitId != null &&
         resource.data.unitId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.unitId &&
         resource.data.createdBy == request.auth.uid)
      );

      // Delete: wecamp_admin peut supprimer n'importe quel défi
      // Animateur peut supprimer uniquement les défis qu'il a créés lui-même
      allow delete: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin' ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' &&
         resource.data.unitId != null &&
         resource.data.unitId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.unitId &&
         resource.data.createdBy == request.auth.uid)
      );
    }

    // Règles pour les soumissions de défis
    match /challengeSubmissions/{submissionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.scoutId;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.scoutId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['animator', 'parent']
      );
    }

    // Règles pour les événements
    // - Animateur: peut créer et modifier les événements
    // - TODO: Remettre la restriction par unitId une fois les données corrigées
    match /events/{eventId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour les présences aux événements
    match /eventAttendances/{attendanceId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.scoutId;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.scoutId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
      );
    }

    // Règles pour les posts du fil d'unité (legacy)
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.authorId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
      );
    }

    // Règles pour les canaux de discussion
    match /channels/{channelId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
      allow update: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' &&
        resource.data.isDefault == false;

      // Règles pour les messages dans les canaux (sous-collection)
      match /messages/{messageId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
        allow update: if request.auth != null && (
          request.auth.uid == resource.data.authorId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
        );
        allow delete: if request.auth != null && (
          request.auth.uid == resource.data.authorId ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
        );
      }
    }

    // Règles pour les messages des canaux
    match /channelMessages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      // Update autorisé pour l'auteur, les animateurs, ou pour modifier les likes
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.authorId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' ||
        // Permettre à tous les utilisateurs authentifiés de modifier les likes
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likesCount', 'commentsCount']))
      );
      allow delete: if request.auth != null && (
        request.auth.uid == resource.data.authorId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
      );
    }

    // Règles pour les commentaires sur les messages
    match /messageComments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      allow update: if request.auth != null && request.auth.uid == resource.data.authorId;
      allow delete: if request.auth != null && (
        request.auth.uid == resource.data.authorId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
      );
    }

    // Règles pour les dossiers de stockage (Drive)
    match /storageFolders/{folderId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour les fichiers stockés (Drive)
    // - Animateurs: peuvent créer/modifier/supprimer tous les fichiers de leur unité
    // - Scouts: peuvent créer des fichiers (photos) dans leur unité (la restriction aux dossiers Photos est gérée côté app)
    match /storageFiles/{fileId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (
        // Animateurs peuvent créer des fichiers
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' ||
        // Scouts peuvent créer des fichiers dans leur unité
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'scout' &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.unitId == request.resource.data.unitId)
      );
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour le statut de lecture des canaux
    match /channelReadStatus/{statusId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && statusId.matches(request.auth.uid + '_.*');
    }

    // Règles pour les badges (définitions)
    // - Admin WeCamp: peut créer/modifier/supprimer les définitions de badges
    // - Autres utilisateurs: lecture seule
    match /badges/{badgeId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin';
    }

    // Règles pour les badges attribués aux scouts
    // - Animateurs: peuvent attribuer des badges aux scouts de leur unité
    // - Admin WeCamp: peut tout faire
    match /scoutBadges/{scoutBadgeId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['animator', 'wecamp_admin'];
    }

    // Règles pour les niveaux
    match /levels/{levelId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour les sections
    // - Lecture publique pour permettre la recherche par code d'accès lors de l'inscription
    // - Création: uniquement admin WeCamp
    // - Modification: admin WeCamp OU tout animateur de l'unité parente
    // - Suppression: uniquement admin WeCamp
    match /sections/{sectionId} {
      allow read: if true;

      // Création de section: uniquement admin WeCamp
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin';

      // Modification: admin WeCamp OU tout animateur de l'unité parente
      allow update: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin' ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.unitId == resource.data.unitId)
      );

      // Suppression: uniquement admin WeCamp
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin';
    }

    // Règles pour les fiches santé
    match /healthRecords/{recordId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (
        request.auth.uid == recordId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['animator', 'parent']
      );
      allow update: if request.auth != null && (
        request.auth.uid == recordId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['animator', 'parent']
      );
      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour les documents (autorisations, etc.)
    match /documents/{documentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour les signatures de documents
    match /documentSignatures/{signatureId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (
        request.auth.uid == request.resource.data.parentId ||
        request.auth.uid == request.resource.data.scoutId
      );
      allow update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator';
    }

    // Règles pour les relations parent-scout
    match /parentScoutRelations/{relationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && (
        request.auth.uid == request.resource.data.parentId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
      );
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.parentId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator'
      );
    }

    // Règles pour les partenaires
    // - Admin WeCamp: peut tout faire (CRUD complet)
    // - Autres utilisateurs: lecture seule
    match /partners/{partnerId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin';
    }

    // Règles pour les offres partenaires
    // - Admin WeCamp: peut tout faire (CRUD complet)
    // - Animateurs: peuvent uniquement incrémenter currentRedemptions (lors d'un échange)
    match /partnerOffers/{offerId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin';
      allow update: if request.auth != null && (
        // Admin peut tout modifier
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'wecamp_admin' ||
        // Animateurs peuvent uniquement modifier currentRedemptions (pour les échanges)
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'animator' &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['currentRedemptions']))
      );
    }

    // Règles pour les échanges de récompenses (redemptions)
    match /redemptions/{redemptionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.usedBy ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['animator', 'wecamp_admin']
      );
    }
  }
}
